Project: MRTDMeatFreshnessDetection
Date: 2026-02-06

OVERVIEW
- Purpose: An application to detect meat freshness/spoilage using a YOLO-based object detector. The repo includes a Flask YOLO server, a CLI prediction script, PHP web front-end pages, helper start scripts, a model artifact, and folders for uploads and annotated predictions.

ARCHITECTURE (High level)
- Frontend (PHP + HTML + CSS)
  - Static pages: landing, about, how-to, contact. These are simple HTML/PHP templates that serve the UI and trigger image capture or upload.
  - `cpe-mrtd_main.php`, `index.php`, `cpe-mrtd_about.php`, `cpe-mrtd_howToUse.php`, `cpe-mrtd_contactUs.php` provide pages and JS that call backend endpoints.
  - JavaScript in the main page interacts with an ESP32-CAM (stream) and posts frames to server endpoints (e.g., `cpe-save_image.php`).

- Backend (PHP glue + Python inference)
  - PHP scripts accept image uploads (via multipart POST), then either:
    - call the local YOLO Flask server (`/predict`) via `curl`, or
    - spawn the CLI predictor (`py-model_predict.py`) as a subprocess if the server is unavailable.
  - Logs are written to `php_yolo_log.txt` and `yolo_server.log`.

- Inference components (Python)
  - `yolo_server.py`: Flask app which loads the YOLO model once, keeps it in memory, and exposes `/predict` and `/health` endpoints for fast inference.
  - `py-model_predict.py`: CLI script that loads the YOLO model, runs a single inference on an image, writes an annotated image to `predicted images/`, and prints a single JSON result.
  - `models/cpe-mf0937-01.pt`: the trained YOLO model weights.

- Helper scripts
  - `start_yolo.bat` and `start_yolo.ps1` start the YOLO server (attempt to use `.venv\Scripts\python.exe` if present), redirect output to `yolo_server.log`, and optionally run minimized/background.

- Data directories
  - `uploads/`: where incoming images are stored by PHP.
  - `predicted images/`: annotated images output by the Python scripts.

FILE-BY-FILE SUMMARY (what each key file does)

1) `yolo_server.py`
- Purpose: Long-running Flask server that holds a YOLO model in memory for low-latency inference.
- Load sequence:
  - Detects device (`cuda` vs `cpu`) and `half` usage for speed when CUDA present.
  - Instantiates `YOLO(MODEL_PATH)` from `ultralytics` and attempts a warmup dummy predict.
- Important functions / endpoints:
  - `@app.route('/predict', methods=['POST'])`
    - Expects multipart form: `image` (file), optional `threshold`, `imgsz`, `client_id`, and `boxes_only`.
    - Reads uploaded bytes, decodes via `cv2.imdecode(numpy.frombuffer(...))`.
    - Calls `model.predict(image, device=device, imgsz=imgsz, conf=threshold, half=use_half)`.
    - Processes object detections (uses OBB output `.obb.*`), converts rotated boxes to axis-aligned bboxes for smoothing.
    - Implements lightweight per-client exponential moving average (EMA) smoothing stored in `SMOOTHING_STATE`.
    - Returns either boxes-only JSON or annotated image path plus predictions.
  - `@app.route('/health')` returns a simple `{'status':'ok','model_ready': True}` JSON.
- Key implementation notes:
  - Uses `ultralytics.YOLO` model and accesses `r.obb` fields for oriented bounding boxes.
  - Smoothing logic: matches detections by name + IoU and applies EMA to bbox and confidence.
  - Annotated images saved to `predicted images/` with millisecond timestamp names.
  - Error handling: broad try/except that returns stack trace in JSON (helpful for debugging but may expose internals).

2) `py-model_predict.py` (aka CLI predictor)
- Purpose: One-shot predictor for command-line or PHP subprocess calls.
- Usage: `python py-model_predict.py <image_path> [threshold]` â†’ prints JSON with `annotated_path` and `predictions`.
- Key steps:
  - Loads model `YOLO(MODEL_PATH)`.
  - Calls `model.predict(source=image_path, imgsz=640, conf=threshold)`.
  - Draws OBBs with `cv2.polylines` and writes output in `predicted images/`.
  - Prints a single JSON to stdout (suitable for capture by PHP `exec` or log).

3) `start_yolo.ps1` & `start_yolo.bat`
- Purpose: Convenience scripts to start `yolo_server.py` in background and write logs to `yolo_server.log`.
- Important syntax:
  - Batch: `start "YOLO" cmd /c "%PY% "%~dp0yolo_server.py" >> "%~dp0yolo_server.log" 2>&1"`
  - PowerShell: uses `Start-Process -FilePath 'cmd.exe' -ArgumentList "/c $cmd" -WindowStyle Minimized`
- Debug tip: if server not starting, check `yolo_server.log` and existence of `.venv\Scripts\python.exe`.

4) `index.php`, `cpe-mrtd_main.php`, and other `cpe-*.php` pages
- Purpose: Frontend pages that handle user interactions (viewing camera stream, triggering capture, sending frames to backend). The main page includes JS that:
  - Streams images from an ESP32-CAM by repeatedly setting an `<img>` src to `http://<esp_ip>/capture?t=<ts>`.
  - On capture, fetches a frame, sends it as multipart POST to `cpe-save_image.php` (server-side handler).
  - Has a 